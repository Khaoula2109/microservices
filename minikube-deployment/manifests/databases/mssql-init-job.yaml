apiVersion: batch/v1
kind: Job
metadata:
  name: mssql-init-db
  namespace: transport-databases
spec:
  ttlSecondsAfterFinished: 100
  template:
    metadata:
      name: mssql-init-db
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mssql-init
        image: mcr.microsoft.com/mssql-tools
        command:
        - /bin/bash
        - -c
        - |
          # Wait for MSSQL to be ready
          echo "Waiting for MSSQL to be ready..."
          until /opt/mssql-tools/bin/sqlcmd -S mssql.transport-databases.svc.cluster.local -U sa -P "$SA_PASSWORD" -Q "SELECT 1" &> /dev/null
          do
            echo "MSSQL is unavailable - sleeping"
            sleep 5
          done

          echo "MSSQL is up - creating database"

          # Create database if it doesn't exist
          /opt/mssql-tools/bin/sqlcmd -S mssql.transport-databases.svc.cluster.local -U sa -P "$SA_PASSWORD" -Q "
          IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'subscription_db')
          BEGIN
            CREATE DATABASE subscription_db;
            PRINT 'Database subscription_db created successfully';
          END
          ELSE
          BEGIN
            PRINT 'Database subscription_db already exists';
          END
          "

          echo "Creating tables in subscription_db..."

          # Create tables for subscription service
          /opt/mssql-tools/bin/sqlcmd -S mssql.transport-databases.svc.cluster.local -U sa -P "$SA_PASSWORD" -d subscription_db -Q "
          IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Plans')
          BEGIN
            CREATE TABLE Plans (
                PlanID INT PRIMARY KEY IDENTITY(1,1),
                Name NVARCHAR(100) NOT NULL,
                StripePriceID NVARCHAR(255) NOT NULL UNIQUE,
                Price DECIMAL(10, 2) NOT NULL,
                DurationInDays INT NOT NULL
            );
            PRINT 'Table Plans created successfully';
          END
          ELSE
          BEGIN
            PRINT 'Table Plans already exists';
          END
          "

          /opt/mssql-tools/bin/sqlcmd -S mssql.transport-databases.svc.cluster.local -U sa -P "$SA_PASSWORD" -d subscription_db -Q "
          IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Users')
          BEGIN
            CREATE TABLE Users (
                UserID BIGINT PRIMARY KEY,
                StripeCustomerID NVARCHAR(255) NOT NULL UNIQUE,
                Email NVARCHAR(255) NOT NULL UNIQUE
            );
            PRINT 'Table Users created successfully';
          END
          ELSE
          BEGIN
            PRINT 'Table Users already exists';
          END
          "

          /opt/mssql-tools/bin/sqlcmd -S mssql.transport-databases.svc.cluster.local -U sa -P "$SA_PASSWORD" -d subscription_db -Q "
          IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Subscriptions')
          BEGIN
            CREATE TABLE Subscriptions (
                SubscriptionID INT PRIMARY KEY IDENTITY(1,1),
                UserID BIGINT NOT NULL,
                PlanID INT NOT NULL,
                StripeSubscriptionID NVARCHAR(255) NOT NULL UNIQUE,
                Status NVARCHAR(50) NOT NULL,
                CurrentPeriodEnd DATETIME NOT NULL,
                CreatedAt DATETIME DEFAULT GETDATE(),
                FOREIGN KEY (PlanID) REFERENCES Plans(PlanID),
                FOREIGN KEY (UserID) REFERENCES Users(UserID)
            );
            PRINT 'Table Subscriptions created successfully';
          END
          ELSE
          BEGIN
            PRINT 'Table Subscriptions already exists';
          END
          "

          # Insert default plans if not exists
          /opt/mssql-tools/bin/sqlcmd -S mssql.transport-databases.svc.cluster.local -U sa -P "$SA_PASSWORD" -d subscription_db -Q "
          IF NOT EXISTS (SELECT * FROM Plans WHERE Name = 'Abonnement Mensuel')
          BEGIN
            INSERT INTO Plans (Name, StripePriceID, Price, DurationInDays) VALUES
            ('Abonnement Mensuel', 'price_1SIrWERxfAGItUbxdErqrsBI', 1000.00, 30);
            PRINT 'Monthly plan inserted';
          END

          IF NOT EXISTS (SELECT * FROM Plans WHERE Name = 'Abonnement Annuel')
          BEGIN
            INSERT INTO Plans (Name, StripePriceID, Price, DurationInDays) VALUES
            ('Abonnement Annuel', 'price_1SIrWjRxfAGItUbxVFplja1P', 10000.00, 365);
            PRINT 'Annual plan inserted';
          END
          "

          echo "Database initialization completed"
        env:
        - name: SA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: mssql-password
